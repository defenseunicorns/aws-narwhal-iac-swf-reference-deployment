includes:
  - deploy: ./tasks/deploy.yaml
  - swf: ./tasks/swf.yaml

tasks:
  - name: help
    description: "Prints a helpful message"
    actions:
      - cmd: |
          cat <<'EOF'
          Welcome to the SWF IaC project!
          To get started, first you'll need to start an AWS session in your current terminal.
          After this, it's recommended to set an $ENV var correlating to a directory under ./iac/env and then run the UDS tasks relating to deploying IaC - for example 'export ENV=dev'
          Alternatively you can use the `set-env` task to persistently set an environment you want to work from. Ex. `uds run set-env --set ENV=dev`
          However `--set` will always take precedence over the environment set via `set-env`
          Please reference each root modules README for more information on the module and its purpose.
          The UDS tasks are here to provide wrappers on executing the modules with certain environment variables and state backend files.
          EOF

  - name: one-time-bootstrap-env
    description: |
      One time bootstrapping of a terraform environment for both the bootstrap and swf modules using the bootstrap root module
      This sets up the backend resources in AWS and templates out the backend.tf file in each root module and generates the ${root_module}-backend.tfconfig files in the ./iac/env/${env}/backends directory.
      example: uds run one-time-bootstrap-env --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - task: deploy:terraform-one-time-bootstrap-per-env
        with:
          env: ${ENV}

  - name: bootstrap-env-dryrun
    description: |-
      Dryrun the one time bootstrapping of a terraform environment for both the bootstrap and swf modules using the bootstrap root module
      example: uds run bootstrap-env-dryrun --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - task: deploy:dryrun-terraform-one-time-bootstrap-per-env
        with:
          env: ${ENV}

  - name: init-bootstrap
    description: |
      terraform init AWS SWF IaC Bootstrap module
      example: uds run init-bootstrap --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "terraform init AWS SWF IaC Bootstrap module"
        task: deploy:terraform-init
        with:
          root_module: bootstrap

  - name: init-reconfigure-backend-bootstrap
    description: |
      Reconfigure the backend for the bootstrap module
      Use this when locally you need to change the environment you're working on, for example going from stg to prd.
      example: uds run init-reconfigure-backend-bootstrap --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Reconfigure the backend for the bootstrap module"
        task: deploy:terraform-backend-reconfigure-init
        with:
          env: ${ENV}
          root_module: bootstrap

  - name: plan-bootstrap
    description: |
      Terraform plan AWS SWF IaC Bootstrap module
      example: uds run plan-bootstrap --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform plan AWS SWF IaC Bootstrap module"
        task: deploy:terraform-plan
        with:
          env: ${ENV}
          root_module: bootstrap
          var_files: '["common.terraform.tfvars", "bootstrap.terraform.tfvars"]'

  - name: apply-bootstrap
    description: |
      Terraform apply AWS SWF IaC Bootstrap module
      example: uds run apply-bootstrap --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform apply AWS SWF IaC Bootstrap module"
        task: deploy:terraform-apply
        with:
          env: ${ENV}
          root_module: bootstrap
          var_files: '["common.terraform.tfvars", "bootstrap.terraform.tfvars"]'

  - name: init-swf
    description: |
      terraform init AWS SWF IaC swf module
      example: uds run init-swf --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "AWS SWF IaC"
        task: deploy:terraform-init
        with:
          root_module: swf

  - name: init-reconfigure-backend-swf
    description: |
      Reconfigure the backend for the swf module
      Use this when locally you need to change the environment you're working on, for example going from stg to prd.
      example: uds run init-reconfigure-backend-swf --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Reconfigure the backend for the swf module"
        task: deploy:terraform-backend-reconfigure-init
        with:
          env: ${ENV}
          root_module: swf

  - name: plan-swf
    description: |
      Terraform plan AWS SWF IaC swf module
      example: uds run plan-swf --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform plan AWS SWF IaC swf module"
        task: deploy:terraform-plan
        with:
          env: ${ENV}
          root_module: swf
          var_files: '["common.terraform.tfvars", "swf.terraform.tfvars"]'

  - name: apply-swf
    description: |
      Terraform apply AWS SWF IaC swf module
      example: uds run apply-swf --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform apply AWS SWF IaC swf module"
        task: deploy:terraform-apply
        with:
          env: ${ENV}
          root_module: swf
          var_files: '["common.terraform.tfvars", "swf.terraform.tfvars"]'

  - name: destroy-swf
    description: |
      Terraform destroy AWS SWF IaC swf module
      example: uds run destroy-swf --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform destroy AWS SWF IaC swf module"
        task: deploy:terraform-destroy
        with:
          env: ${ENV}
          root_module: swf
          var_files: '["common.terraform.tfvars", "swf.terraform.tfvars"]'

  - name: init-transit-gateway
    description: |
      terraform init AWS SWF IaC transit-gateway module
      example: uds run init-transit-gateway --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform init AWS SWF IaC transit-gateway module"
        task: deploy:terraform-init
        with:
          root_module: transit-gateway

  - name: init-reconfigure-backend-transit-gateway
    description: |
      Reconfigure the backend for the transit-gateway module.
      Use this when locally you need to change the environment you're working on, for example going from stg to prd.
      example: uds run init-reconfigure-backend-transit-gateway --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Reconfigure the backend for the transit-gateway module"
        task: deploy:terraform-backend-reconfigure-init
        with:
          env: ${ENV}
          root_module: transit-gateway

  # Ideally, we would like to ensure that the swf module is applied and state reconciled before the transit-gateway module
  - name: plan-transit-gateway
    description: |
      Terraform plan AWS SWF IaC transit-gateway module
      NOTE: This task should be run after the swf module has been applied. It relies on reading the remote backend of the swf module to get information from the VPC.
      example: uds run plan-transit-gateway --set ENV=$ENV
    actions:
      # - description: "Terraform apply AWS SWF IaC swf module"
      #   task: deploy:terraform-apply
      #   with:
      #     env: ${ENV}
      #     root_module: swf
      #     var_files: '["common.terraform.tfvars", "swf.terraform.tfvars"]'
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform plan AWS SWF IaC transit-gateway module"
        task: deploy:terraform-plan
        with:
          env: ${ENV}
          root_module: transit-gateway
          var_files: '["common.terraform.tfvars", "context.tfvars", "swf-backend.tfconfig", "transit-gateway.terraform.tfvars"]'

  - name: apply-transit-gateway
    description: |
      Terraform apply AWS SWF IaC transit-gateway module
      NOTE: This task should be run after the swf module has been applied. It relies on reading the remote backend of the swf module to get information from the VPC.
      example: uds run apply-transit-gateway --set ENV=$ENV
    actions:
      # - description: "Terraform apply AWS SWF IaC swf module"
      #   task: deploy:terraform-apply
      #   with:
      #     env: ${ENV}
      #     root_module: swf
      #     var_files: '["common.terraform.tfvars", "swf.terraform.tfvars"]'
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Terraform apply AWS SWF IaC transit-gateway module"
        task: deploy:terraform-apply
        with:
          env: ${ENV}
          root_module: transit-gateway
          var_files: '["common.terraform.tfvars", "context.tfvars", "swf-backend.tfconfig", "transit-gateway.terraform.tfvars"]'

  - name: get-bastion-instance-id
    description: |
      Get the bastion instance id
      Use this when you need to get the bastion instance id for the environment you're working in.
      example: uds run get-bastion-instance-id --set ENV=$ENV
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Get the bastion instance id"
        task: deploy:get-bastion-instance-id
        with:
          env: ${ENV}

  - name: bundle-all
    description: "Creates the zarf package, then builds and deploys the bundle"
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - task: swf:zarf-create
      - task: swf:bundle-create
      - task: swf:bundle-deploy

  - name: zarf-create
    actions:
      - description: "Create the zarf package"
        task: swf:zarf-create

  - name: bundle-create
    actions:
      - description: "Create the zarf package"
        task: swf:zarf-create
      - description: "Create the swf bundle"
        task: swf:bundle-create

  - name: bundle-deploy
    actions:
      - description: "Get the current environment"
        task: deploy:get-env
      - description: "Deploy the swf bundle"
        task: swf:bundle-deploy

  - name: echo
    actions:
      - description: "Just echo"
        task: deploy:just-echo
        with:
          list: '["hello", "world"]'
          env: ${ENV}

  - name: set-env
    actions:
      - description: |
          Set a persistent environment to be used for all runner commands
          example: uds run set-env --set ENV=dev
        shell:
          linux: bash
          darwin: bash
        cmd: |
          set -euo pipefail
          printf ${ENV} > .current-env

  - name: read-env
    actions:
      - task: deploy:get-env
      - description: "Read the environment"
        cmd: 'echo "Current Environment: ${ENV}"'