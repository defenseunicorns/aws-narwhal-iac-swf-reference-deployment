kind: UDSBundle
metadata:
  name: swf
  description: A UDS bundle for deploying a swf to narwhal reference deployment
  version: "0.1.0"

packages:
  - name: zarf-init-s3-backend
    repository: ghcr.io/defenseunicorns/zacks-zarf-funhouse/init
    ref: v0.32.2

  - name: storageclass
    repository: ghcr.io/defenseunicorns/packages/narwhal-delivery-zarf-package-eks-addons/storageclass
    ref: 0.0.1
    optionalComponents:
      - fetch-staged-aws-ssm-vars
      - ebs-storageclass
      - efs-storageclass

  - name: aws-load-balancer-controller
    repository: ghcr.io/defenseunicorns/packages/narwhal-delivery-zarf-package-eks-addons/aws-load-balancer-controller
    ref: 0.0.1
    optionalComponents:
      - fetch-staged-aws-ssm-vars

  - name: core
    repository: ghcr.io/defenseunicorns/packages/uds/core
    ref: 0.16.1-registry1
    overrides:
      kube-prometheus-stack:
            kube-prometheus-stack:
              values:
                - path: kube-state-metrics.resources.limits.memory
                  value: 512Mi
      keycloak:
        keycloak:
          values:
            - path: devMode
              value: false
            - path: fips
              value: true
            - path: postgresql.database
              value: keycloakdb
            - path: postgresql.username
              value: keycloak
          variables:
            - path: postgresql.password
              name: KC_DB_PASSWORD
            - path: postgresql.host
              name: KC_DB_HOST
      neuvector:
        core:
          values:
            - path: k3s.enabled
              value: false
            - path: containerd.enabled
              value: true
            - path: containerd.path
              value: /run/containerd/containerd.sock
      istio-admin-gateway:
        gateway:
          values:
            - path: service.annotations
              value:
                service.beta.kubernetes.io/aws-load-balancer-type: "external"
                service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
                service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "instance"
                service.beta.kubernetes.io/aws-load-balancer-attributes: "load_balancing.cross_zone.enabled=true"
      istio-tenant-gateway:
        gateway:
          values:
            - path: service.annotations
              value:
                service.beta.kubernetes.io/aws-load-balancer-type: "external"
                service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
                service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "instance"
                service.beta.kubernetes.io/aws-load-balancer-attributes: "load_balancing.cross_zone.enabled=true"
      istio-passthrough-gateway:
        gateway:
          values:
            - path: service.annotations
              value:
                service.beta.kubernetes.io/aws-load-balancer-type: "external"
                service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
                service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "instance"
                service.beta.kubernetes.io/aws-load-balancer-attributes: "load_balancing.cross_zone.enabled=true"

  - name: cluster-autoscaler
    repository: ghcr.io/defenseunicorns/packages/narwhal-delivery-zarf-package-eks-addons/cluster-autoscaler
    ref: 0.0.1-registry1
    optionalComponents:
      - fetch-staged-aws-ssm-vars

  - name: aws-node-termination-handler
    repository: ghcr.io/defenseunicorns/packages/narwhal-delivery-zarf-package-eks-addons/aws-node-termination-handler
    ref: 0.0.1-registry1
    optionalComponents:
      - fetch-staged-aws-ssm-vars

  - name: swf-deps-aws
    path: ../../
    ref: "0.1.0"

  - name: gitlab
    repository: ghcr.io/defenseunicorns/packages/uds/gitlab
    ref: 16.9.2-uds.0-registry1
    overrides:
      gitlab:
        gitlab:
          values:
            - path: global.appConfig.omniauth.autoSignInWithProvider
              value: ""
          variables:
            - name: REGISTRY_ROLE_ARN
              description: "The ARN of the role to assume for the registry pods"
              path: registry.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
            - name: SIDEKIQ_ROLE_ARN
              description: "The ARN of the role to assume for the sidekiq pods"
              path: gitlab.sidekiq.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
            - name: WEBSERVICE_ROLE_ARN
              description: "The ARN of the role to assume for the web service pods"
              path: gitlab.webservice.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
            - name: TOOLBOX_ROLE_ARN
              description: "The ARN of the role to assume for the toolbox pods"
              path: gitlab.toolbox.serviceAccount.annotations.eks\.amazonaws\.com/role-arn
            - name: LFS_BUCKET
              description: "The name of the S3 bucket to use for LFS storage"
              path: gitlab.global.appConfig.lfs.bucket
            - name: ARTIFACTS_BUCKET
              description: "The name of the S3 bucket to use for artifacts storage"
              path: gitlab.global.appConfig.artifacts.bucket
            - name: UPLOADS_BUCKET
              description: "The name of the S3 bucket to use for uploads storage"
              path: gitlab.global.appConfig.uploads.bucket
            - name: PACKAGES_BUCKET
              description: "The name of the S3 bucket to use for packages storage"
              path: gitlab.global.appConfig.packages.bucket
            - name: EXTERNAL_DIFFS_BUCKET
              description: "The name of the S3 bucket to use for external diffs storage"
              path: gitlab.global.appConfig.externalDiffs.bucket
            - name: TERRAFORM_STATE_BUCKET
              description: "The name of the S3 bucket to use for terraform state storage"
              path: gitlab.global.appConfig.terraformState.bucket
            - name: CI_SECURE_FILES_BUCKET
              description: "The name of the S3 bucket to use for CI secure files storage"
              path: gitlab.global.appConfig.ciSecureFiles.bucket
            - name: DEPENDENCY_PROXY_BUCKET
              description: "The name of the S3 bucket to use for dependency proxy storage"
              path: gitlab.global.appConfig.dependencyProxy.bucket
            - name: BACKUPS_BUCKET
              description: "The name of the S3 bucket to use for backups storage"
              path: gitlab.global.appConfig.backups.bucket
            - name: BACKUPS_TMP_BUCKET
              description: "The name of the S3 bucket to use for temporary backups storage"
              path: gitlab.global.appConfig.backups.tmpBucket
            - name: REGISTRY_BUCKET
              description: "The name of the S3 bucket to use for registry storage"
              path: gitlab.global.registry.bucket
            - name: PAGES_BUCKET
              description: "The name of the S3 bucket to use for pages storage"
              path: gitlab.global.pages.objectStore.bucket

  - name: gitlab-runner
    repository: ghcr.io/defenseunicorns/packages/uds/gitlab-runner
    ref: 16.9.1-uds.2-registry1

  - name: mattermost
    repository: ghcr.io/defenseunicorns/packages/uds/mattermost
    ref: 9.4.1-uds.2-registry1
    overrides:
      mattermost:
        uds-mattermost-config:
          variables:
            - name: MATTERMOST_DB_ENDPOINT
              path: "postgres.host"
            - name: MATTERMOST_DB_PASSWORD
              path: "postgres.password"
            - name: MATTERMOST_DB_NAME
              path: "postgres.dbName"
            - name: MATTERMOST_BUCKET
              path: "objectStorage.bucket"
            - name: MATTERMOST_REGION
              path: "objectStorage.region"
            - name: MATTERMOST_S3_ENDPOINT
              path: "objectStorage.endpoint"
        mattermost-enterprise-edition:
          variables:
            - name: MATTERMOST_ROLE_ARN
              path: "serviceAccount.annotations.irsa/role-arn"

  - name: jenkins
    repository: ghcr.io/defenseunicorns/packages/uds/jenkins
    ref: 5.1.0-uds.0

  - name: jira
    repository: ghcr.io/defenseunicorns/packages/uds/jira
    ref: 1.17.2-uds.0-registry1

  - name: confluence
    repository: ghcr.io/defenseunicorns/packages/uds/confluence
    ref: 1.18.0-uds.0-registry1

  - name: artifactory
    repository: ghcr.io/defenseunicorns/packages/uds/artifactory
    ref: 107.77.7-uds.0-registry1
